---
- name: "Recursively find *.jar files"
  find:
    paths: "{{ deploy_helper.new_release_path }}"
    file_type: "file"
    patterns: "*.jar"
  register: "jarfiles"

- name: "Recreate symlinks"
  file:
    src: '{{ item.path }}'
    dest: "{{ deploy_helper.shared_path }}/{{ item.path | regex_replace(deploy_helper.new_release_path) }}"
    state: link
    force: true
  with_items: "{{ jarfiles.files }}"

- name: "Recursively find plugin config directories"
  find:
    paths: "{{ deploy_helper.new_release_path }}"
    file_type: "directory"
  register: "plugindirectories"


- name: copying file with owner and permissions
  synchronize:
    src: '{{ item.path }}'
    dest: "{{ deploy_helper.shared_path }}/{{ item.path | regex_replace(deploy_helper.new_release_path) }}"
    dirs: true
    recursive: true
    rsync_opts:
      - "--chown={{ minecraft_user }}:{{ minecraft_group }}"
  delegate_to: "{{ inventory_hostname }}"
  with_items: "{{ plugindirectories.files }}"
  changed_when: False
